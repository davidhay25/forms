
<div>
    <div class="modal-header">

        <div class="row">
            <div class="col-md-6 col-sm-6 col-xs-6">

                <h3 ng-show="editType == 'edit'" class="modal-title">Edit Item: <em>{{newItem.text}}</em></h3>
                <h3 ng-show="editType == 'new'" class="modal-title">New Item</h3>
            </div>
            <div class="col-md-6 col-sm-6 col-xs-6">



                <button ng-show="newItem.text && newItem.linkId" class="btn btn-success pull-right"
                        ng-click="save()">

                    <div ng-show="editType == 'edit'">Save changes</div>
                    <div ng-show="editType == 'new'">Add new item</div>
                </button>
                <button class="btn btn-link pull-right" ng-click="cancel()">Cancel</button>

            </div>

        </div>

    </div>
    <div class="modal-body">



        <uib-tabset>
            <uib-tab heading="Details">
                <br/>



                <table class="table table-condensed">
                    <tr>
                        <td>Parent</td>
                        <td><input type="text" disabled = "disabled"

                                   ng-model="parent.item.text" class="form-control"/> </td>

                    </tr>

                    <tr>
                        <td>Text</td>
                        <td><input type="text" autofocus
                                   ng-change="makeLinkId(newItem.text)"
                                   placeholder="Text to display to the user"
                                   ng-model="newItem.text" class="form-control"/> </td>

                    </tr>

                    <tr>
                        <td>LinkId</td>

                        <td><input type="text" ng-disabled = "dependantOnThis.length > 0"
                                   placeholder="A unique (in this Q) identifier for the item"
                                   ng-blur="checkUniqueLinkId(newItem.linkId)"
                                   ng-model="newItem.linkId" class="form-control"/> </td>

                    </tr>


                    <tr>
                        <td>Description</td>
                        <td><textarea
                                   placeholder="Description of the item. Displayed in the UI"
                                   ng-model="meta.description" class="form-control"></textarea>
                        </td>

                    </tr>



                    <tr>
                        <td>Flags</td>
                        <td>
                            <div class="row">
                                <div class="col-sm-3 col-md-3">
                                    <checkbox ng-model="newItem.repeats"></checkbox> Repeats
                                </div>
                                <div class="col-sm-3 col-md-3">
                                    <checkbox ng-model="newItem.required"></checkbox> Mandatory
                                </div>
                                <div class="col-sm-3 col-md-3">
                                    <checkbox ng-model="meta.hidden"></checkbox> Hidden
                                </div>
                            </div>
                        </td>

                    </tr>



                    <!-- If a section, then the type will be 'group'-->
                    <tr>
                        <td>Type</td>
                        <td>
                            <div class="row">
                                <div class="col-sm-4">
                                    <select ng-hide = "fixType" class="form-control" ng-model="newItem.type"
                                            ng-change = setHISODefaults(newItem.type)
                                            ng-options = "itemType for itemType in input.itemTypes"></select>

                                    <div ng-show="fixType">
                                        {{newItem.type}}
                                    </div>

                                </div>

                                <div class="col-sm-6">

                                    <div ng-show="newItem.type == 'group'">
                                        <div class="row">
                                            <div class="col-sm-6 col-md-6">
                                                Column count
                                            </div>
                                            <div class="col-sm-3 col-md-3">

                                                <select class="form-control" ng-model="meta.columnCount"
                                                        ng-options = "cnt for cnt in input.colCount">

                                                </select>
                                                
                                            </div>
                                        </div>
                                    </div>

                                    <div ng-show="newItem.type == 'reference'">

                                        <div ng-repeat = "ref in meta.referenceTypes">
                                            {{ref}}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-2">
                                    <button class="btn btn-link pull-right" ng-hide="fixType"
                                            ng-click="setHISODefaults(newItem.type)">Reset HISO
                                    </button>
                                </div>
                            </div>


                        </td>
                    </tr>



                    <tr ng-show = "newItem.type == 'quantity'">
                        <td>Units</td>
                        <td>
                            <input class="form-control" type="text" ng-model="newItem.tmp.units"
                                   placeholder="Units (using UCUM)"/>
                            <em>Add link to UCUM or a lookup</em>
                        </td>

                    </tr>

                    <tr ng-show = "newItem.type == 'choice' || newItem.type == 'open-choice'">
                        <td>ValueSet</td>
                        <td>
                            <div class="row">
                                <div class="col-md-5 col-sm-5">
                                    <input class="form-control" type="text" ng-model="newItem.answerValueSet"
                                           disabled = "disabled"
                                           placeholder="ValueSet url"/>
                                </div>
                                <div class="col-md-2 col-sm-2">
                                  <!--  <button class="btn btn-link" ng-click="newVS()">Select</button> -->

                                    <button class="btn btn-link" ng-click="editVS(newItem.answerValueSet)">Edit</button>
                                </div>
                                <div class="col-md-5 col-sm-5">
                                    <div style="padding-top: 6px"> Render:
                                        <input type="radio" ng-model="input.vs.rendermode" value="radio"> Radio
                                        <input type="radio" ng-model="input.vs.rendermode" value="dropdown"> Dropdown
                                        <input type="radio" ng-model="input.vs.rendermode" value="lookup"> Lookup
                                    </div>

                                </div>

                            </div>
                        </td>
                    </tr>

                    <tr ng-hide="fixType">
                        <td>HISO</td>
                        <td>
                            <div class="row">

                                <div class="col-md-3 col-sm-3">
                                    <label>Class</label>
                                    <select class="form-control" ng-model="meta.hisoClass"
                                            ng-options = "class for class in input.hisoClass"></select>
                                </div>

                                <div class="col-md-3 col-sm-3">
                                    <label>Length</label>
                                    <input type="text" class="form-control" ng-model = "meta.hisoLength" />
                                </div>

                                <div class="col-md-3 col-sm-3">
                                    <label>DataType</label>
                                    <select class="form-control" ng-model="meta.hisoDT"
                                            ng-options = "dt for dt in input.hisoDT"></select>
                                </div>

                                <div class="col-md-3 col-sm-3">
                                    <label>Layout</label>
                                    <input type="text" class="form-control" ng-model = "meta.hisoLayout" />
                                </div>

                            </div>

                        </td>
                    </tr>

                    <tr ng-hide = "newItem.type == 'display' ">
                        <td>Code</td>
                        <td>

                            <div class="row">
                                <div class="col-md-4">
                                    <input class="form-control" type="text" ng-model="newItem.tmp.codeCode"
                                           placeholder="Code"/>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-control" ng-model="newItem.tmp.codeSystem"
                                            ng-options = "system.display for system in input.codeSystems"></select>
                                </div>
                                <div class="col-md-4">
                                    <input class="form-control" type="text" ng-model="newItem.tmp.codeDisplay"
                                           placeholder="Display"/>
                                </div>
                            </div>

<!--
                            <div><em>If a code is supplied, the item will be extracted as an Observation</em></div>
                            -->
                        </td>
                    </tr>

                    <tr ng-show = "insertType == 'child' && newItem.item.length > 0">
                        <td>Column count</td>
                        <td>
                            <div class="row">
                                <div class="col-sm-3 col-md-3">
                                    <input class="form-control" type="text" ng-model="meta.columnCount"
                                           placeholder="Column count"/>
                                </div>
                            </div>


                        </td>
                    </tr>

                    <tr ng-show = "newItem.enableWhen">
                        <td>Conditional</td>
                        <td>
                            <div ng-repeat = "ew in newItem.enableWhen">
                                Conditional on value of <em>{{ew.question}}</em>. Details in conditional tab.
                            </div>

                        </td>
                    </tr>

                    <tr ng-show = "meta.extraction.extractObservation || meta.extraction.notes">
                        <td>Resource extraction</td>
                        <td>
                            <div ng-show="meta.extraction.extractObservation">
                                Will be extracted as an Observation
                            </div>
                            <div ng-show="meta.extraction.notes">
                                <p>
                                    {{meta.extraction.notes}}
                                </p>
                            </div>
                        </td>
                    </tr>


                </table>


            </uib-tab>

            <uib-tab heading = "Notes">
                <br/>
                <strong>Guide for use</strong>
                <textarea class="form-control" ng-model="meta.usageNotes">

                </textarea>

                <strong>Source Standard</strong>
                <textarea class="form-control" ng-model="meta.sourceStandard"> </textarea>

                <strong>Verification rules</strong>
                <textarea class="form-control" ng-model="meta.verification"> </textarea>

                <strong>General Notes</strong>
                <textarea class="form-control" ng-model="meta.notes"> </textarea>

            </uib-tab>

            <uib-tab heading = "Resource mapping">


                <br/><br/>

                <checkbox ng-model="meta.extraction.extractObservation"> </checkbox> Extract as Observation
                <br/><br/>

                <strong>Resource extraction Notes</strong>
                <textarea class="form-control" ng-model="meta.extraction.notes"> </textarea>


                <em>Instructions to map from this element into a resource</em>



            </uib-tab>

            <uib-tab ng-show = "newItem.type == 'integer' || newItem.type == 'string'" >
                <uib-tab-heading>Answer options <span class="badge">{{newItem.answerOption.length}}</span> </uib-tab-heading>
                <br/>

                <div class="row ">
                    <div class="col-md-6">
                        <div class="list-group">
                            <div class="list-group-item" ng-repeat = "option in newItem.answerOption">
                                <span class="pull-right">

                                     <i class=" clickable glyphicon glyphicon-arrow-up" ng-show="$index > 0"
                                        ng-click = "moveAnswerUp($index)"></i>
                                     <i class=" clickable glyphicon glyphicon-arrow-down"  ng-show="$index < newItem.answerOption.length -1"
                                        ng-click = "moveAnswerDown($index)"></i>

                                    <i class=" clickable glyphicon glyphicon-remove"
                                       ng-click = "removeAnswerOption($index)"></i>

                                </span>

                                {{option.valueInteger}} {{option.valueString}}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <checkbox ng-model="input.displayAsRadio"></checkbox> Display as Radio buttons
                    </div>
                </div>


                <div class="row ">
                    <div class="col-md-6">
                        <input type="text" class="form-control" ng-model="input.newAnswerOption"/>
                    </div>
                    <div class="col-md-6">
                        <button class="btn-link btn" ng-click="addOtherAnswerOption(input.newAnswerOption)">Add</button>
                    </div>
                </div>







            </uib-tab>


            <uib-tab ng-show="! newItem.answerValueSet && (newItem.type == 'choice' || newItem.type == 'open-choice')" >
                <uib-tab-heading>Possible values <span class="badge">{{newItem.answerOption.length}}</span> </uib-tab-heading>
                <br/>
                <table class="table table-bordered table-condensed">
                    <tr><th>Code</th><th>System</th><th>Display</th></tr>
                    <tr ng-repeat = "option in newItem.answerOption">
                        <td>{{option.valueCoding.code}}</td>
                        <td>
                            {{option.valueCoding.system}}
                        </td>
                        <td>{{option.valueCoding.display}}</td>
                        <td>
                            <i class=" clickable glyphicon glyphicon-remove"
                               ng-click = "removeAnswerOption($index)"></i>
                        </td>
                        <td>
                            <i class=" clickable glyphicon glyphicon-arrow-up" ng-show="$index > 0"
                                ng-click = "moveAnswerUp($index)"></i>
                            <i class=" clickable glyphicon glyphicon-arrow-down"  ng-show="$index < newItem.answerOption.length -1"
                                ng-click = "moveAnswerDown($index)"></i>

                        </td>
                    </tr>
                    <tr>
                        <td><input type="text" class="form-control" placeholder="Code" ng-model="input.newAnswerCode"/> </td>
                        <td>

                            <select class="form-control" ng-model="input.newAnswerSystem"
                                    ng-options = "system.display for system in input.codeSystems"></select>
                            <!--
                            <input type="text" class="form-control" placeholder="System" ng-model="newAnswerSystem"/>
                        -->
                        </td>
                        <td><input type="text" class="form-control" placeholder="Display" ng-model="input.newAnswerDisplay"/> </td>
                        <td>
                            <i ng-show="input.newAnswerCode && input.newAnswerDisplay"
                               class="clickable glyphicon glyphicon-plus-sign"
                               ng-click = "addAnswerOption(input.newAnswerCode,input.newAnswerSystem.url,input.newAnswerDisplay)"></i>


                    </tr>
                </table>

            </uib-tab>

            <!--
            <uib-tab ng-show = "newItem.answerValueSet" heading = "ValueSet contents">

                if one of our VS (?publisher ?url root) - allow editing. simple list of concepts. later could have $expand
                If not, then allow $expand

                <div ng-controller="terminologyCtrl">
                    <ng-include src = "'includes/vsEditor.html'"></ng-include>
                </div>



            </uib-tab>
            -->


            <uib-tab ng-show = "false" heading = "Conditional show">

                <div class="row">
                    <div class="col-sm-5">
                        <strong>Source question</strong>
                        <br/>
                        <select ng-model="input.ewQuestion" class="form-control"
                                ng-change = "ewSelected(input.ewQuestion)"
                                ng-options = "item.text for item in dependencySources"></select>
                        <br/>
                        <em>The question that this one depends on</em>
                    </div>

                    <div class="col-sm-2">
                        <div ng-show = "selectedSourceItem.type == 'integer'" style="padding-top: 8px">
                            <input type="radio" ng-model="input.conditionalOperator" value="="/> =
                            <div><input type="radio" ng-model="input.conditionalOperator" value=">"/> ></div>
                        </div>

                    </div>


                    <div class="col-sm-5">

                        <div ng-show = "selectedSourceItem.type == 'choice' || selectedSourceItem.type == 'open-choice'">
                            <strong>Value to show this item</strong>
<!--
                            <select ng-model="input.ewAnswer"  class="form-control"
                                    ng-options = "concept.display for concept in input.ewQuestionOptions"></select>
-->
                            <select ng-model="input.ewAnswer"  class="form-control"
                                    ng-options = "concept.valueCoding.display for concept in selectedSourceItem.answerOption"></select>

                            <br/>
                            {{selectedSourceItem.type}}
                            <em>The value of the source question that will display this one</em>
                        </div>

                        <div ng-show = "selectedSourceItem.type == 'string'">
                            <strong>Value to show this item</strong>
                            <br/>
                            <select ng-model="input.ewAnswerString"  class="form-control"
                                    ng-options = "item.valueString for item in selectedSourceItem.answerOption"></select>
                        </div>

                        <div ng-show = "selectedSourceItem.type == 'integer'">
                            <strong>Value to show this item</strong>
                            <br/>
                            <select ng-model="input.ewAnswerInteger"  class="form-control"
                                    ng-options = "item.valueInteger for item in selectedSourceItem.answerOption"></select>
                        </div>

                        <div ng-show = "selectedSourceItem.type == 'boolean'">
                            <strong>Value to show this item</strong>
                            <br/><br/>
                            <input type="radio" ng-model="input.ewAnswerBoolean" value="yes"/> True
                            <input type="radio" ng-model="input.ewAnswerBoolean" value="no"/> False
                        </div>

<!--
                        <div ng-show="input.ewQuestion.type == 'choice' || input.ewQuestion.type == 'open-choice'">
                            <strong>Value to show this item</strong>

                            <select ng-model="input.ewAnswer"  class="form-control"

                                ng-options = "concept.display for concept in input.ewQuestionOptions"></select>

                            <br/>
                            <em>The value of the source question that will display this one</em>
                        </div>


                        <div ng-show="input.ewQuestion.type == 'boolean'">
                            <strong>Value to show this item</strong>
                            <br/><br/>
                            <input type="radio" ng-model="input.ewAnswerBoolean" value="yes"/> True
                            <input type="radio" ng-model="input.ewAnswerBoolean" value="no"/> False
                        </div>

                        -->

                    </div>
                </div>
<!--
                <pre>{{newItem.enableWhen | json}}</pre>
-->



                <br/><br/>
                <em>Set the source question and value that controls if this item is to be displayed. Source questions can be:
                    <ul>
                        <li>Questions of type 'choice' with in-line options.</li>
                        <li>Questions of type string with in-line options.</li>
                        <li>Boolean (yes/no) questions</li>
                    </ul>


                </em>
                <em>Currently, only a single conditional is supported - this can be relaxed if needed...</em>

                <div class="row" ng-show = "newItem.enableWhen">
                    <div class="col-sm-12 col-md-12">
                        <button class="btn btn-danger pull-right" ng-click="clearConditional()">Clear conditional</button>
                    </div>
                </div>

            </uib-tab>


            <uib-tab heading = "Conditional show">
                <table class="table table-bordered">
                    <tr><th>Source (trigger)</th><th>Operator</th><th>Value</th><th></th></tr>
                    <tr ng-repeat="ew in newItem.enableWhen">
                        <td>{{ew.question}}</td>
                        <td>{{ew.operator}}</td>
                        <td>
                            <span ng-show = "ew.answerCoding"> {{ew.answerCoding.code}} ({{ew.answerCoding.display}})</span>
                            <span ng-show = "ew.answerBoolean !== undefined"> {{ew.answerBoolean}}</span>
                            <span ng-show = "ew.answerString">{{ew.answerString}}</span>
                        </td>
                        <td><i class="btn btn-link glyphicon glyphicon-remove clickable pull-right"
                               ng-click="deleteSourceTrigger($index)"></i>
                        </td>
                    </tr>
                </table>

                <div class="clickable" ng-click="input.addDependency = ! input.addDependency">Add new dependency</div>

                <div class="rounded-box" ng-show="input.addDependency">
                    <div class="row">
                        <div class="col-sm-5">
                            <strong>Source question</strong>
                            <br/>
                            <select ng-model="input.newEwQuestion" class="form-control"
                                    ng-change = "ewSelected(input.newEwQuestion)"
                                    ng-options = "item.text for item in dependencySources"></select>
                            <br/>
                            <em>The question that this one depends on</em>
                        </div>

                        <div class="col-sm-1">
                            <div ng-show = "newEwSelectedSourceItem.type == 'integer'" style="padding-top: 8px">
                                <input type="radio" ng-model="input.conditionalOperator" value="="/> =
                                <div><input type="radio" ng-model="input.conditionalOperator" value=">"/> ></div>
                            </div>

                        </div>

                        <div class="col-sm-3">

                            <div ng-show = "newEwSelectedSourceItem.type == 'choice' || newEwSelectedSourceItem.type == 'open-choice'">
                                <strong>Value to show this item</strong>

                                <select ng-model="input.ewAnswerConcept"  class="form-control"
                                        ng-options = "concept.valueCoding.display for concept in selectedSourceItem.answerOption"></select>

                                <br/>
                                {{selectedSourceItem.type}}
                                <em>The value of the source question that will display this one</em>
                            </div>

                            <div ng-show = "newEwSelectedSourceItem.type == 'string'">
                                <strong>Value to show this item</strong>
                                <br/>
                                <select ng-model="input.ewAnswerString"  class="form-control"
                                        ng-options = "item.valueString for item in selectedSourceItem.answerOption"></select>
                            </div>

                            <div ng-show = "newEwSelectedSourceItem.type == 'integer'">
                                <strong>Value to show this item</strong>
                                <br/>
                                <select ng-model="input.ewAnswerInteger"  class="form-control"
                                        ng-options = "item.valueInteger for item in selectedSourceItem.answerOption"></select>
                            </div>

                            <div ng-show = "newEwSelectedSourceItem.type == 'boolean'">
                                <strong>Value to show this item</strong>
                                <br/><br/>
                                <input type="radio" ng-model="input.ewAnswerBoolean" value="yes"/> True
                                <input type="radio" ng-model="input.ewAnswerBoolean" value="no"/> False
                            </div>


                        </div>
                        <div class="col-sm-3">
                            <div  style="padding-top: 20px">
                                <button class="btn btn-danger pull-right" ng-click="addNewEw()">Add</button>
                            </div>

                        </div>
                    </div>
                </div>


            </uib-tab>

            <uib-tab ng-show = "dependantOnThis.length > 0" heading = "Dependant on this">
                <br/>
                <table class="table-bordered table">
                    <tr><th>LinkId</th><th>Text</th><th>Condition</th></tr>
                    <tr ng-repeat = "item in dependantOnThis">
                        <td>{{item.linkId}}</td>
                        <td>{{item.text}}</td>
                        <td><div ng-repeat = "ew in item.enableWhen">
                            <strong>{{ew.operator}}</strong> {{ew.answerCoding}} {{ew.answerBoolean}}
                        </div></td>


                    </tr>
                </table>

                <em>Items that have a show/hide dependency on this one</em>

            </uib-tab>

            <uib-tab ng-show="false" heading = "HISO elements">
                <br/>
                <div class="row">
                    <div class="col-md-3 col-sm-3">
                        HISO DataType
                    </div>
                    <div class="col-md-9 col-sm-9">
                        <select class="form-control" ng-model="meta.HisoDt">

                        </select>
                    </div>
                </div>

            </uib-tab>

            <uib-tab ng-show = "true" heading = "Json">
                <br/>
                <pre>{{newItem | json}}</pre>
            </uib-tab>

        </uib-tabset>


</div>

    <div class="modal-header">

        {{editType}} {{insertType}}

        <div class="row">
            <div class="col-md-12 col-sm-12">
                <!--
                <button class="btn btn-success pull-right"
                        ng-click="save()">

                    <div ng-show="editType == 'edit'">Save changes</div>
                    <div ng-show="editType == 'new'">Add new item</div>
                </button>

                -->
            </div>
        </div>
    </div>
</div>
